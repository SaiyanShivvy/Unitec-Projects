<!doctype html>
<!-- TODO: Move Inline Script functions to external seats.js -->
<!-- TODO: Make the refreshing of the total easier -->
<!-- TODO: locally persist booking data better -->
<!-- TODO: Do the Game -->

<!-- NOTE: Seat constains a class which is derivative of there layout, so you can check against that for if it from a certain boat layout -->
<!-- NOTE: This allows for resuing for functions instead of writing multiple doing the same thing -->

<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Assignment 2 - Test 3</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!-- <script type="text/javascript" src="seats.js"></script> -->
  <link rel="stylesheet" type="text/css" href="mStyle.css">
</head>

<body>
  <script>
    var seatRose = [];
    var seatPrincess = [];

    function seat(id, row, isBooked, price) {
      this.id = id;
      this.row = row;
      this.isBooked = isBooked;
      this.price = price;
    }

    function getRose() {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.open("get", "rose.xml", true);
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          createRoseSeat(this);
        }
      };
      xmlhttp.send(null);
    }

    function getPrincess() {
      var xmlhttp = new XMLHttpRequest();
      xmlhttp.open("get", "princess.xml", true);
      xmlhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          createPrincessSeat(this);
        }
      };
      xmlhttp.send(null);
    }

    function createRoseSeat(xmlhttp) {
      var xmlDoc = xmlhttp.responseXML.documentElement;
      var x = xmlDoc.getElementsByTagName("seat");

      var sID = '';
      var sRow = '';
      var sBook = '';
      var sPrice = '';
      for (i = 0; i < x.length; i++) {
        sID = x[i].getElementsByTagName("id")[0].childNodes[0].nodeValue;
        sRow = x[i].getElementsByTagName("row")[0].childNodes[0].nodeValue;
        sBook = x[i].getElementsByTagName("isBooked")[0].childNodes[0].nodeValue;
        sPrice = x[i].getElementsByTagName("price")[0].childNodes[0].nodeValue;
        //console.log(sID, sRow, sBook, sPrice);

        var newSeat = new seat(sID, sRow, sBook, sPrice);
        seatRose[i] = newSeat;
      }
    }

    function createPrincessSeat(xmlhttp) {
      var xmlDoc = xmlhttp.responseXML.documentElement;
      var x = xmlDoc.getElementsByTagName("seat");

      var sID = '';
      var sRow = '';
      var sBook = '';
      var sPrice = '';
      for (i = 0; i < x.length; i++) {
        sID = x[i].getElementsByTagName("id")[0].childNodes[0].nodeValue;
        sRow = x[i].getElementsByTagName("row")[0].childNodes[0].nodeValue;
        sBook = x[i].getElementsByTagName("isBooked")[0].childNodes[0].nodeValue;
        sPrice = x[i].getElementsByTagName("price")[0].childNodes[0].nodeValue;
        //console.log(sID, sRow, sBook, sPrice);

        var newSeat = new seat(sID, sRow, sBook, sPrice);
        seatPrincess[i] = newSeat;
      }
    }

    //init
    window.onload = function() {
      getRose();
      getPrincess();
    }

    function selectSeat(cell) {
      // - [x] TODO: Add or Remove Seat from Cart
      // - [x] TODO: Calculate Total

      var cart = document.getElementById('selected-seats');
      var liCart = document.createElement("li");
      var rmCart;
      if (cell.classList.contains("rose")) {
        if (cell.classList.contains("booked")) {
          alert("Sorry, bud. You were to slow and this seat " + cell.id + " is now booked.")
        } else if (cell.classList.contains('selected')) {
          cell.classList.toggle("selected");
          rmCart = document.getElementById("cart-item-" + cell.id);
          rmCart.parentNode.removeChild(rmCart);
          //console.log(cell);
        } else {
          cell.classList.toggle("selected");
          liCart.setAttribute("id", "cart-item-" + cell.id)
          liCart.appendChild(document.createTextNode("R. Seat " + cell.id));
          cart.append(liCart);
          seatDetails(cell);
          //console.log(cell);
        }
      } else if (cell.classList.contains("princess")) {
        if (cell.classList.contains("booked")) {
          alert("Sorry, bud. You were to slow and this seat " + cell.id + " is now booked.")
        } else if (cell.classList.contains('selected')) {
          cell.classList.toggle("selected");
          rmCart = document.getElementById("cart-item-" + cell.id);
          rmCart.parentNode.removeChild(rmCart);
          //console.log(cell);
        } else {
          cell.classList.toggle("selected");
          liCart.setAttribute("id", "cart-item-" + cell.id)
          liCart.appendChild(document.createTextNode("P. Seat " + cell.id));
          cart.append(liCart);
          seatDetails(cell);
          //console.log(cell);
        }
      }
    }

    function seatDetails(cell) {
      // - [ ] TODO: When Seat is selected display the booking details from the array.
      var seatInfo = document.getElementById('seatInfo');
      var seatPrice = document.getElementById('seatPrice');
      if (cell.classList.contains("rose")) {
        if (cell.classList.contains("selected")) {
          seatInfo.textContent = cell.id;
          seatPrice.textContent = "$" + getSeatPrice("rose", cell.id);
          total.textContent = "$" + calcTotal("rose", cell.id);
        } else {
          seatInfo.textContent = " ";
          seatPrice.textContent = " ";
          total.textContent = calcTotal("rose", cell.id);
        }
      } else if (cell.classList.contains("princess")) {
        if (cell.classList.contains("selected")) {
          seatInfo.textContent = cell.id;
          seatPrice.textContent = "$" + getSeatPrice("princess", cell.id);
          total.textContent = calcTotal("princess", cell.id);
        } else {
          seatInfo.textContent = " ";
          seatPrice.textContent = " ";
          total.textContent = calcTotal("princess", cell.id);
        }
      }
    }

    function getSeatPrice(boat, id) {
      //console.log(id);
      if (boat == "rose") {
        for (var i = 0; i < seatRose.length; i++) {
          if (seatRose[i].id == id) {
            var sP = seatRose[i].price;
          }
        }
      } else if (boat = "princess") {
        for (var i = 0; i < seatPrincess.length; i++) {
          if (seatPrincess[i].id == id) {
            var sP = seatPrincess[i].price;
          }
        }
      }
      return sP;
    }

    function calcTotal(boat) {
      var total = document.getElementById('total');
      var nTotal = 0;
      if (boat == "rose") {
        // recalcutate total by looking for all cells that have the class sleceted and adding thrie totals
        var selected = document.getElementsByClassName('rose');
        for (var i = 0; i < selected.length; i++) {
          if (selected[i].classList.contains("selected")) {
            nTotal += parseFloat(getSeatPrice(boat, selected[i].id));
            console.log(nTotal);
          }
        }
      } else if (boat == "princess") {
        var selected = document.getElementsByClassName('princess');
        for (var i = 0; i < selected.length; i++) {
          if (selected[i].classList.contains("selected")) {
            nTotal += parseFloat(getSeatPrice(boat, selected[i].id));
            console.log(nTotal);
          }
        }
      }
      return nTotal;
    }

    // Displaying the Layouts
    function display_rose() {
      var table = document.getElementById('roseLayout');
      var numRows = 9;
      var numCol = 9;
      var sNum = 0;
      for (var i = 0; i < numRows; i++) {
        var row = table.insertRow(i);
        for (var j = 0; j < numCol; j++) {
          //cellName = seatRose[sNum].id + "_" + seatRose[sNum].row;
          cellName = seatRose[sNum].id
          //console.log(cellName);
          cell = row.insertCell(row.cells.length);
          if (seatRose[sNum].id == 'M' || seatRose[sNum].id == 'W') {
            cell.innerHTML = '<div>' + '</div>';
            cell.setAttribute("class", "walk rose");
            //console.log("Cell:" + seatRose[sNum].id);
          } else {
            if (seatRose[sNum].isBooked == "yes") {
              cell.innerHTML = '<div>' + seatRose[sNum].id + '</div>';
              cell.setAttribute("class", "seat booked rose");
            } else {
              cell.innerHTML = '<div>' + seatRose[sNum].id + '</div>';
              cell.setAttribute("class", "seat rose");
            }
            cell.setAttribute("id", cellName);
            cell.setAttribute("onclick", "selectSeat(this)");
            row.appendChild(cell);
          }
          sNum = sNum + 1;
        }
      }
      table.appendChild(row);
    }

    function display_Princess() {
      var table = document.getElementById('princessLayout');
      var numRows = 13;
      var numCol = 9;
      var sNum = 0;
      for (var i = 0; i < numRows; i++) {
        var row = table.insertRow(i);
        for (var j = 0; j < numCol; j++) {
          //cellName = seatPrincess[sNum].id + "_" + seatPrincess[sNum].row;
          cellName = seatPrincess[sNum].id
          //console.log(cellName);
          cell = row.insertCell(row.cells.length);
          if (seatPrincess[sNum].id == 'M' || seatPrincess[sNum].id == 'W') {
            cell.innerHTML = '<div>' + '</div>';
            cell.setAttribute("class", "walk princess");
            //console.log("Cell:" + seatPrincess[sNum].id);
          } else {
            if (seatPrincess[sNum].isBooked == "yes") {
              cell.innerHTML = '<div>' + seatPrincess[sNum].id + '</div>';
              cell.setAttribute("class", "seat booked princess");
            } else {
              cell.innerHTML = '<div>' + seatPrincess[sNum].id + '</div>';
              cell.setAttribute("class", "seat princess");
            }
            cell.setAttribute("id", cellName);
            cell.setAttribute("onclick", "selectSeat(this)");
            row.appendChild(cell);
          }
          sNum = sNum + 1;
        }
      }
      table.appendChild(row);
    }
  </script>

  <div id="navbar">
    <ul>
      <li>
        <a href="index.html">Seat Booking</a>
      </li>
      <li>
        <a href="game.html">Game</a>
      </li>
      <li>
        <a href="http://dochyper.unitec.ac.nz/iwd18s1/2379/achars05IWD/wordpress/">Wordpress</a>
      </li>
    </ul>
  </div>

  <h1>Rose Layout</h1>
  <div class="wrapper">
    <div class="container">
      <!-- Seats -->
      <button type="button" onclick="display_rose()">Rose Boat</button>
      <button type="button" onclick="display_Princess()">Princess Boat</button>
      <table border='1' id="roseLayout"></table>
      <br />
      <table border='1' id="princessLayout"></table>

      <!-- Bokking Details -->
      <div class="booking-details">
        <h2>Booking Details</h2>
        <h4>Time:
          <!-- <input id="datetime" type="datetime-local"> -->
          <select id="DateTime">
            <option value="date1">18 May 2017 - 10:30 AM</option>
            <option value="date2" selected>18 May 2017 - 12:30 PM</option>
            <option value="date3">18 May 2017 - 2:30 PM</option>
          </select>
        </h4>
        <h4>Seat:
          <span id="seatInfo"></span>
        </h4>
        <h4>Price:
          <span id="seatPrice"></span>
        </h4>
        <h3> Selected Seats:
          <span id="counter"></span>
        </h3>
        <ul id="selected-seats"></ul>
        Total:
        <b>$
          <span id="total">0</span>
        </b>
      </div>
    </div>
  </div>
</body>

</html>
